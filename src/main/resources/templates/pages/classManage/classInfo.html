<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout_common}">

<!--현재 페이지에서 쓰이는 스크립트-->
<th:block layout:fragment="script">
  <!-- Ekko Lightbox -->
  <script src="/plugins/ekko-lightbox/ekko-lightbox.min.js"></script>
  <!-- Filterizr-->
  <script src="/plugins/filterizr/jquery.filterizr.min.js"></script>
  <!-- Select2 -->
  <script src="/plugins/select2/js/select2.full.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="/plugins/sweetalert2/sweetalert2.min.js"></script>
  <!-- Toastr -->
  <script src="/plugins/toastr/toastr.min.js"></script>

  <!--  컴포넌트의 동작에 필요한 인라인 스크립트-->
  <script th:inline="javascript">
    $(function(){
      $("#profileImg").click(function(){
        $('#imgUpload').click();
      });
      $('#imgUpload').change(function(event) {
        var file = event.target.files[0];
        if(!isImageFile(file)) {
          return;
        }
        var reader = new FileReader();
        reader.onload = function(e) {
          $("#profileImg").attr("src", e.target.result);
        }
        reader.readAsDataURL(file);
        $('#imgBtn').css('display', 'block');
      });
      getClassCard("A");
      getClassCard("B");
      setInit();
    });
    function setInit() {
      $(".background-wrap").on("click", function() {
        var id = $(this).children().children().data('sid');
        if(id != null) {
          initModal();
          infoModal(id);
          $('#Mname').data("sid", id);
          $('#imgBtn').css('display', 'none');
          $('#imgUpload').val(null);
          $('#galleryModal').modal();
        }
      })
      $('#editSeatsA').click(function(){
        $('#editSeatsA').css('display', 'none');
        $('#saveSeatsA').css('display', 'block');
        $('#bCard').css('display', 'none');
        const aSeatsSize = 32;
        let seatA = 'span#seatA-';
        for(var i=1; i<=aSeatsSize; i++) {
          var seat = seatA + i;
          $(seat).css("color", "gray");
          $(seat).text(i);
        }
        showEdit("A");
      });
      $('#editSeatsB').click(function(){
        $('#editSeatsB').css('display', 'none');
        $('#saveSeatsB').css('display', 'block');
        $('#aCard').css('display', 'none');
        const bSeatsSize = 18;
        let seatB = 'span#seatB-';
        for(var j=1; j<=bSeatsSize; j++) {
          var seat = seatB + j;
          $(seat).css("color", "gray");
          $(seat).text(j);
        }
        showEdit("B");
      });
      $('#saveSeatsA').click(function() {
        var studentSeats = [];
        $('.select2bs4 option:selected').each((index, item) => {
          studentSeats.push({"id" : item.value,
            "name" : item.text,
            "seat" : index+1
          });
        });
        updateSeat(studentSeats);
        closeEdit();
        getClassCard("A");
        $('#editSeatsA').css('display', 'block');
        $('#saveSeatsA').css('display', 'none');
        $('#bCard').css('display', 'block');
      });
      $('#saveSeatsB').click(function() {
        var studentSeats = [];
        $('.select2bs4 option:selected').each((index, item) => {
          studentSeats.push({"id" : item.value,
            "name" : item.text,
            "seat" : index+1
          });
        });
        updateSeat(studentSeats);
        closeEdit();
        getClassCard("B");
        $('#editSeatsB').css('display', 'block');
        $('#saveSeatsB').css('display', 'none');
        $('#aCard').css('display', 'block');
      });
    }
    function updateSeat(studentSeats) {
      $.ajax({
        contentType: 'application/json;charset=UTF-8',
        type: "PATCH",
        async: false,
        url: "/class/update",
        data: JSON.stringify(studentSeats),
        dataType: "json",
        cache   : false,
        success: function () {
          getSeats();
          toastInfo('success', '자리 배치가 변경되었습니다');
        },
        error : function(jqXHR){
          if(jqXHR.status == '401'){
            alert('로그인 후 이용해주세요');
            //location.href='/members/login';
          } else{
            alert(jqXHR.responseText);
          }
        }
      });
    }
    function getClassCard(classab) {
      var url = "/class/info/" + classab
      $.ajax({
        url: url,
        type: "GET",
        async: false,
        dataType : "html",
        cache   : false,
        success  : function(data){
          if(classab==="A") {
            $('#aCard').children().remove();
            $('#aCard').append(data);
          }else if(classab==="B") {
            $('#bCard').children().remove();
            $('#bCard').append(data);
          }
          getSeats();
          setInit();
        },
        error : function(jqXHR){
          if(jqXHR.status == '401'){
            alert('로그인 후 이용해주세요');
            //location.href='/members/login';
          } else{
            alert(jqXHR.responseText);
          }
        }
      });
    }
    function showEdit(classab) {
      var url = "/class/edit/" + classab
      $.ajax({
        url: url,
        type: "GET",
        async: false,
        dataType : "html",
        cache   : false,
        success  : function(data){
          $('#editCard').children().remove();
          $('#editCard').append(data);
          $('.select2bs4').select2({
            theme: 'bootstrap4',
          })
          $('#editCard').css('display', 'block');
        },
        error : function(jqXHR){
          if(jqXHR.status == '401'){
            alert('로그인 후 이용해주세요');
            //location.href='/members/login';
          } else{
            alert(jqXHR.responseText);
          }
        }
      });
    }
    function closeEdit() {
      $('#editCard').children().remove();
      $('#editCard').css('display', 'none');
    }
    function isImageFile(file) {
      var ext = file.name.split(".").pop().toLowerCase(); // 파일명에서 확장자를 가져온다.
      return ($.inArray(ext, ["jpg", "jpeg", "gif", "png"]) === -1) ? false : true;
    }
    function getSeats() {
      $.ajax({
        url: "/class/seats",
        type: "POST",
        dataType: "json",
        async: false,
        cache: false,
        success: function(result) {
          let seatA = 'span#seatA-';
          let seatB = 'span#seatB-';
          var dataA = result.dataA;
          var dataB = result.dataB;
          $.each(dataA, function (index, item) {
            var seat = seatA + item.seat;
            $(seat).text(item.name);
            $(seat).css("color", "black");
            $(seat).data("sid", item.id);
          });
          $.each(dataB, function (index, item) {
            var seat = seatB + item.seat;
            $(seat).text(item.name);
            $(seat).css("color", "black");
            $(seat).data("sid", item.id);
          });
        }
      })
    };
    function infoModal(id) {
      var url = "/class/detail/" + id;
      $.ajax({
        url: url,
        type: "GET",
        dataType : "json",
        cache   : false,
        success  : function(data){
          var source = '/image/'+data.image;
          $('#profileImg').attr('src', source);
          $('#Mname').text(' ' + data.student.name);
          $('#Mbirth').text(' ' + data.student.birth);
          $('#Mphone').text('' + data.student.phone);
          $('#Memail').text(' ' + data.student.email);
          $('#Mresidence').text(' ' + data.student.residence);
          $('#Mbelong').text(' ' + data.student.belong);
          $('#Mmajor').text(' ' + data.student.major);
          $('#Mgraduate').text(' ' + data.student.graduate);
          $('#Mstart').text(' ' + data.student.start);
          $('#Mnote').text(' ' + data.student.note);
        },
      });
    }
    function initModal() {
      $('#Mname').text('');
      $('#Mbirth').text('');
      $('#Mphone').text('');
      $('#Memail').text('');
      $('#Mresidence').text('');
      $('#Mbelong').text('');
      $('#Mmajor').text('');
      $('#Mgraduate').text('');
      $('#Mstart').text('');
      $('#Mnote').text('');
    }
    function upload() {
      const imgUpload = $('#imgUpload')[0];
      if(imgUpload.files.length === 0) {
        alert("파일을 선택해주세요");
        return;
      }
      const formData = new FormData();
      formData.append("img", imgUpload.files[0]);
      var id = $('#Mname').data("sid");
      $.ajax({
        type: 'POST',
        url: '/class/profileImg/' + id,
        enctype: 'multipart/form-data',
        cache: false,
        processData: false,
        contentType: false,
        data: formData,
        success: function(result) {
          var source = '/image/'+result.oriImgName;
          $('#profileImg').attr('src', source);
          $('#imgBtn').css('display', 'none');
          toastInfo('success', '이미지가 적용되었습니다');
        },
      })
    }
    function toastInfo(icon, title) {
      Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000
      }).fire({
        icon: icon,
        title: title,
      })
    }
  </script>
</th:block>

<!--현재 페이지에서 쓰이는 스타일시트-->
<th:block layout:fragment="css">
  <!-- Ekko Lightbox -->
  <link rel="stylesheet" href="/plugins/ekko-lightbox/ekko-lightbox.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
  <link rel="stylesheet" href="/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
  <!-- Toastr -->
  <link rel="stylesheet" href="/plugins/toastr/toastr.min.css">

  <!--  컴포넌트의 동작에 필요한 인라인 css-->
  <style th:inline="css">
    .background-wrap:hover {
      background-image: url('/image/seatHover.png');
    }
    .background-wrap {
      background-image: url('/image/seatDefault.png');
      width: 100px;
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: auto;
    }
    .content {
      display: flex;
      flex-direction: column;
    }
    .content span {
      color: gray;
    }
    .content span:nth-child(1) {
      font-size: 15px;
      font-weight: bold;
    }
    #uploadForm {
      display: none;
    }
    #imgBtn {
      display: none;
    }
  </style>
</th:block>

<th:block layout:fragment="content">
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>자리배치도</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">홈</a></li>
              <li class="breadcrumb-item active">강의실 자리배치도</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <!-- A반 자리 카드 -->
          <div class="col-md-6" id="aCard"></div>
          <!-- 자리편집 학생 리스트 display : none<->block -->
          <div class="col-md-6" id="editCard" style="display: none"></div>
          <!-- B반 자리 카드 -->
          <div class="col-md-6" id="bCard"></div>
        </div>
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <div id="galleryModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-center mb-0 text-muted"><b id="Mname"></b></h3>
          <button type="button" class="close float-right" aria-label="Close" data-dismiss="modal">
            <span aria-hidden="true">&#xD7;</span>
          </button>
        </div>
        <div class="modal-body text-center bg-alt p-5">
          <div class="row">
            <div class="col-5 text-center align-self-center">
              <form id="uploadForm" enctype="multipart/form-data">
                <input id="imgUpload" type="file" name="img">
              </form>
              <div class="row justify-content-center">
                <img id="profileImg" style="object-fit: cover" src="/image/gray.png" alt="사진" class="shadow-sm img-fluid mb-3">
              </div>
              <div class="row justify-content-center">
                <button id="imgBtn" class="btn btn-info btn-sm float-right" onclick="upload()">이미지 저장</button>
              </div>
            </div>
            <div class="col-7">
              <p><b>생년월일 &nbsp;</b><span class="text-muted text-sm" id="Mbirth"></span></p>
              <p><span><i class="fas fa-lg fa-phone"></i>&nbsp;</span><span class="text-muted text-sm" id="Mphone"></span></p>
              <p><span><i class="fas fa-envelope"></i>&nbsp;</span><span class="text-muted text-sm" id="Memail"></span></p>
              <p><b>거주지 &nbsp;</b><span class="text-muted text-sm" id="Mresidence"></span></p>
              <p><b>소속 &nbsp;</b><span class="text-muted text-sm" id="Mbelong"></span></p>
              <p><b>전공 &nbsp;</b><span class="text-muted text-sm" id="Mmajor"></span></p>
              <p><b>최종 학력 &nbsp;</b><span class="text-muted text-sm" id="Mgraduate"></span></p>
              <p><b>수강시작일 &nbsp;</b><span class="text-muted text-sm" id="Mstart"></span></p>
              <p><b>특이사항 &nbsp;</b><span class="text-muted text-sm" id="Mnote"></span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</th:block>
</html>
